#!/usr/bin/sh

# Copyright 2021 (c) Sreedev Kodichath

# Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
# associated documentation files (the "Software"), to deal in the Software without restriction, 
# including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense,
# and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so,
# subject to the following conditions:

# The above copyright notice and this permission notice shall be included in all copiesor substantial
# portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT
# LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
# WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

RED=$(tput setaf 4)
YELLOW=$(tput setaf 5)
NC=$(tput sgr0) # No Color

help() {
  echo "luks-good: (L)inux (U)nified (K)ey (S)etup Helper Functions"
  echo 
  echo "Usage:"
  echo "luks-good [command] [opts]"
  echo 
  echo "Commands:"
  printf "%s\t\t%s\n" "create-partition ${RED}/dev/sdX1${NC}" "formats /dev/sdX1 to a LUKS encrypted partition" 
  printf "%s\t\t%s\n" "mount-partition ${RED}/dev/sdX1 ${YELLOW}/mnt${NC}" "mounts LUKS encrypted partition /dev/sdX1 to /mnt" 
  printf "%s\t\t%s\n" "umount-partition ${RED}/dev/sdX1${NC}" "unmounts LUKS encrypted parition" 
  printf "%s\t\t\t\t%s\n" "list-partitions" "lists all LUKS encrypted partitions" 
}

createPartition() {
  echo "creating partition on $1"
  # v - verbose | y - confirm password | s - keysize | h - hash
  sudo cryptsetup -v -y -c aes-xts-plain64 -s 512 -h sha512 -i 5000 --use-random luksFormat $1
  # TODO: Ensure that there is no existing mapper label called datadevenc
  sudo cryptsetup luksOpen $1 datadevenc
  sudo mkfs.ext4 /dev/mapper/datadevenc
  sudo cryptsetup close /dev/mapper/datadevenc
}

unmountPartition() {
  # TODO: Take Device location & convert it to mapper label
  # sudo umount $1
  # sudo cryptsetup close $1
}

mountPartition() {
  echo "mounting partition on $1 at $2"
  # TODO: Accept Custom Labels
  sudo cryptsetup open $1 datadevenc
  sudo mount /dev/mapper/datadevenc $2
}

case $1 in
  create-partition)
    createPartition $2
    ;;
  mount-partition)
    mountPartition $2 $3
    ;;
  unmount-partition)
    unmountPartition $2
    ;;
  *)
    help
    ;;
esac
